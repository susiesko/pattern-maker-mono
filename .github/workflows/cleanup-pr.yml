name: Cleanup PR Apps (Railway)

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  cleanup:
    name: Cleanup PR Apps
    runs-on: ubuntu-latest
    environment: pr
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Cleanup PR API app
        run: |
          PR_APP_API="beadpantry-api-pr-${{ github.event.number }}"
          echo -e "\033[31mðŸ—‘ï¸  Starting cleanup for PR API app: $PR_APP_API\033[0m"
          
          # Railway CLI will use RAILWAY_TOKEN env var automatically
          echo -e "\033[36mðŸ”‘ Authenticating with Railway...\033[0m"
          
          # Delete API project
          echo -e "\033[33mðŸ’¥ Destroying API project: $PR_APP_API\033[0m"
          if railway delete --name $PR_APP_API --yes; then
            echo -e "\033[32mâœ… Successfully destroyed API app: $PR_APP_API\033[0m"
            echo "ðŸ—‘ï¸ PR API app destroyed: $PR_APP_API" >> $GITHUB_STEP_SUMMARY
          else
            echo -e "\033[36mðŸ¤· API app not found: $PR_APP_API\033[0m"
            echo "â„¹ï¸ PR API app not found: $PR_APP_API" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Cleanup PR frontend app
        run: |
          PR_APP_UI="beadpantry-ui-pr-${{ github.event.number }}"
          echo -e "\033[31mðŸ—‘ï¸  Starting cleanup for PR frontend: $PR_APP_UI\033[0m"
          
          # Railway CLI will use RAILWAY_TOKEN env var automatically
          echo -e "\033[36mðŸ”‘ Authenticating with Railway...\033[0m"
          
          # Delete frontend project
          echo -e "\033[33mðŸ’¥ Destroying frontend project: $PR_APP_UI\033[0m"
          if railway delete --name $PR_APP_UI --yes; then
            echo -e "\033[32mâœ… Successfully destroyed frontend: $PR_APP_UI\033[0m"
            echo "ðŸ—‘ï¸ PR frontend destroyed: $PR_APP_UI" >> $GITHUB_STEP_SUMMARY
          else
            echo -e "\033[36mðŸ¤· Frontend project not found: $PR_APP_UI\033[0m"
            echo "â„¹ï¸ PR frontend not found: $PR_APP_UI" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}