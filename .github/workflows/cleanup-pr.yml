name: Cleanup PR Apps

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  cleanup:
    name: Cleanup PR App
    runs-on: ubuntu-latest
    environment: pr
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Cleanup PR app
        run: |
          PR_APP="beadpantry-api-pr-${{ github.event.number }}"
          echo -e "\033[31mðŸ—‘ï¸  Starting cleanup for PR app: $PR_APP\033[0m"
          
          # Check if app exists before trying to destroy
          if flyctl apps list | grep -q $PR_APP; then
            echo -e "\033[33mðŸ’¥ Destroying app: $PR_APP\033[0m"
            flyctl apps destroy $PR_APP --yes
            echo -e "\033[32mâœ… Successfully destroyed: $PR_APP\033[0m"
            echo "ðŸ—‘ï¸ PR app destroyed: $PR_APP" >> $GITHUB_STEP_SUMMARY
          else
            echo -e "\033[36mðŸ¤· App not found (may have been manually deleted): $PR_APP\033[0m"
            echo "â„¹ï¸ PR app not found: $PR_APP" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
