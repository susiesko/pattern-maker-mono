name: Cleanup PR Apps

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  cleanup:
    name: Cleanup PR App
    runs-on: ubuntu-latest
    environment: pr
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Cleanup PR API app
        run: |
          PR_APP="beadpantry-api-pr-${{ github.event.number }}"
          echo -e "\033[31mðŸ—‘ï¸  Starting cleanup for PR API app: $PR_APP\033[0m"
          
          # Debug: Show all apps and search for our specific app
          echo -e "\033[36mðŸ“‹ All apps:\033[0m"
          flyctl apps list
          echo -e "\033[36mðŸ” Looking for app: $PR_APP\033[0m"
          flyctl apps list | grep "$PR_APP" || echo "No matching app found"
          
          # Check if app exists before trying to destroy
          if flyctl apps list | grep -q $PR_APP; then
            echo -e "\033[33mðŸ’¥ Destroying API app: $PR_APP\033[0m"
            flyctl apps destroy $PR_APP --yes
            echo -e "\033[32mâœ… Successfully destroyed API app: $PR_APP\033[0m"
            echo "ðŸ—‘ï¸ PR API app destroyed: $PR_APP" >> $GITHUB_STEP_SUMMARY
          else
            echo -e "\033[36mðŸ¤· API app not found (may have been manually deleted): $PR_APP\033[0m"
            echo "â„¹ï¸ PR API app not found: $PR_APP" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Cleanup PR frontend
        run: |
          PROJECT_NAME="beadpantry-ui-pr-${{ github.event.number }}"
          echo -e "\033[31mðŸ—‘ï¸  Starting cleanup for PR frontend: $PROJECT_NAME\033[0m"
          
          # Delete Cloudflare Pages project
          echo -e "\033[33mðŸ’¥ Destroying frontend project: $PROJECT_NAME\033[0m"
          if npx wrangler pages project delete "$PROJECT_NAME" --yes; then
            echo -e "\033[32mâœ… Successfully destroyed frontend: $PROJECT_NAME\033[0m"
            echo "ðŸ—‘ï¸ PR frontend destroyed: $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY
          else
            echo -e "\033[36mðŸ¤· Frontend project not found: $PROJECT_NAME\033[0m"
            echo "â„¹ï¸ PR frontend not found: $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}