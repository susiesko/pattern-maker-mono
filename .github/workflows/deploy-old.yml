name: Deploy to Fly.io (DISABLED)

on:
  push:
    branches: [disabled-never-run]  # Changed to disable
  pull_request:
    branches: [disabled-never-run]  # Changed to disable
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy API
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'pr' }}
    defaults:
      run:
        working-directory: ./api
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: |
          echo -e "\033[34mðŸš€ Deploying to production app: beadpantry-api\033[0m"
          flyctl deploy --remote-only --app beadpantry-api --config ./fly.toml
          echo -e "\033[32mâœ… Production deployment complete: https://beadpantry-api.fly.dev\033[0m"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Deploy PR preview
        if: github.event_name == 'pull_request'
        run: |
          PR_APP="beadpantry-api-pr-${{ github.event.number }}"
          echo -e "\033[35mðŸ”§ Setting up PR preview app: $PR_APP\033[0m"
          
          # Debug: Show all apps and search for our specific app
          echo -e "\033[36mðŸ“‹ All apps:\033[0m"
          flyctl apps list
          echo -e "\033[36mðŸ” Looking for app: $PR_APP\033[0m"
          flyctl apps list | grep "$PR_APP" || echo "No matching app found"
          
          # Debug: Show all apps and search for our specific app
          echo -e "\033[36mðŸ“‹ All apps:\033[0m"
          flyctl apps list
          echo -e "\033[36mðŸ” Looking for app: $PR_APP\033[0m"
          flyctl apps list | grep "$PR_APP" || echo "No matching app found"
          
          # Create app
          if ! flyctl apps list | grep -q $PR_APP; then
            echo -e "\033[33mðŸ“¦ Creating new app: $PR_APP\033[0m"
            flyctl apps create $PR_APP --org personal
          else
            echo -e "\033[36mâ™»ï¸  App already exists: $PR_APP\033[0m"
          fi
          
          # Set secrets for PR app
          echo -e "\033[33mðŸ” Setting secrets for: $PR_APP\033[0m"
          flyctl secrets set --app $PR_APP \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
            RAILS_MASTER_KEY="${{ secrets.RAILS_MASTER_KEY }}" \
            ALLOWED_ORIGINS="*"
          
          # Deploy to PR app
          echo -e "\033[34mðŸš€ Deploying PR app: $PR_APP\033[0m"
          flyctl deploy --remote-only --app $PR_APP --config ./fly.toml
          echo -e "\033[32mâœ… PR deployment complete: https://$PR_APP.fly.dev\033[0m"
          echo "ðŸš€ PR app deployed: https://$PR_APP.fly.dev" >> $GITHUB_STEP_SUMMARY
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}