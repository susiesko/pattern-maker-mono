name: Deploy to Fly.io

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, closed]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy API
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'pr' }}
    defaults:
      run:
        working-directory: ./api
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: flyctl deploy --remote-only --app beadpantry-api --config ./fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Deploy PR preview
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        run: |
          PR_APP="beadpantry-api-pr-${{ github.event.number }}"
          
          # Create app
          if ! flyctl apps list | grep -q $PR_APP; then
            flyctl apps create $PR_APP --org personal
          else
            echo "App $PR_APP already exists"
          fi
          
          # Set secrets for PR app
          flyctl secrets set --app $PR_APP \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
            RAILS_MASTER_KEY="${{ secrets.RAILS_MASTER_KEY }}" \
            ALLOWED_ORIGINS="*"
          
          # Deploy to PR app
          flyctl deploy --remote-only --app $PR_APP --config ./fly.toml
          echo "🚀 PR app deployed: https://$PR_APP.fly.dev" >> $GITHUB_STEP_SUMMARY
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Cleanup PR app
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        run: |
          PR_APP="beadpantry-api-pr-${{ github.event.number }}"
          flyctl apps destroy $PR_APP --yes 2>/dev/null || true
          echo "🗑️ PR app destroyed: $PR_APP" >> $GITHUB_STEP_SUMMARY
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}